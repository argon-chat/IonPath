namespace ion.compiler.CodeGen.Templates;

/// <summary>
/// Провайдер шаблонов для генерации сериализаторов, клиентов и серверных executor'ов.
/// Шаблоны содержат плейсхолдеры вида {placeholderName} которые заменяются генератором.
/// </summary>
public interface ITemplateProvider
{
    // ???????????????????????????????????????????????????????????????????
    // FORMATTER TEMPLATES
    // ???????????????????????????????????????????????????????????????????

    /// <summary>
    /// Шаблон форматтера для message типа.
    /// Placeholders: {typeName}, {readFields}, {writeFields}, {fieldsCount}, {ctorArgs}
    /// </summary>
    string FormatterTemplate { get; }

    /// <summary>
    /// Шаблон форматтера для union case типа (с конструктором new).
    /// </summary>
    string FormatterUnionCaseTemplate { get; }

    /// <summary>
    /// Шаблон форматтера для enum.
    /// Placeholders: {typeName}, {baseTypeName}, {readExpr}, {writeExpr}
    /// </summary>
    string FormatterEnumTemplate { get; }

    /// <summary>
    /// Шаблон форматтера для flags enum.
    /// </summary>
    string FormatterFlagsTemplate { get; }

    /// <summary>
    /// Шаблон форматтера для union interface.
    /// Placeholders: {unionName}, {readCases}, {writeCases}
    /// </summary>
    string FormatterUnionTemplate { get; }

    /// <summary>
    /// Шаблон одного case в read секции union форматтера.
    /// Placeholders: {caseIndex}, {caseTypeName}
    /// </summary>
    string FormatterUnionReadCaseTemplate { get; }

    /// <summary>
    /// Шаблон одного case в write секции union форматтера.
    /// </summary>
    string FormatterUnionWriteCaseTemplate { get; }

    // ???????????????????????????????????????????????????????????????????
    // SERVICE CLIENT TEMPLATES
    // ???????????????????????????????????????????????????????????????????

    /// <summary>
    /// Шаблон класса клиентской реализации сервиса.
    /// Placeholders: {serviceName}, {methods}, {methodInfoDecls}
    /// </summary>
    string ServiceClientClassTemplate { get; }

    /// <summary>
    /// Шаблон unary метода с возвратом.
    /// Placeholders: {serviceName}, {methodName}, {returnType}, {args}, {argsCount}, {writeArgs}
    /// </summary>
    string ServiceClientMethodTemplate { get; }

    /// <summary>
    /// Шаблон unary метода без возврата (void).
    /// </summary>
    string ServiceClientMethodVoidTemplate { get; }

    /// <summary>
    /// Шаблон streaming метода.
    /// Placeholders: добавляется {streamCall}
    /// </summary>
    string ServiceClientMethodStreamTemplate { get; }

    /// <summary>
    /// Шаблон для array return type метода.
    /// </summary>
    string? ServiceClientMethodArrayTemplate { get; }

    /// <summary>
    /// Шаблон для nullable return type метода.
    /// </summary>
    string? ServiceClientMethodNullableTemplate { get; }

    // ???????????????????????????????????????????????????????????????????
    // SERVICE EXECUTOR TEMPLATES (Server-side)
    // ???????????????????????????????????????????????????????????????????

    /// <summary>
    /// Шаблон класса executor'а сервиса.
    /// Placeholders: {serviceName}, {methods}, {routerBody}, {streamRouterBody}, {interfaces}
    /// </summary>
    string ServiceExecutorClassTemplate { get; }

    /// <summary>
    /// Шаблон unary метода executor'а.
    /// </summary>
    string ServiceExecutorMethodTemplate { get; }

    /// <summary>
    /// Шаблон void метода executor'а.
    /// </summary>
    string ServiceExecutorMethodVoidTemplate { get; }

    /// <summary>
    /// Шаблон streaming метода executor'а.
    /// </summary>
    string ServiceExecutorMethodStreamTemplate { get; }

    /// <summary>
    /// Шаблон router метода (для dispatch по имени).
    /// </summary>
    string ServiceExecutorRouterTemplate { get; }

    /// <summary>
    /// Шаблон stream router метода.
    /// </summary>
    string ServiceExecutorStreamRouterTemplate { get; }

    /// <summary>
    /// Шаблон одной branch в router.
    /// </summary>
    string ServiceExecutorBranchTemplate { get; }

    /// <summary>
    /// Шаблон для каста input stream.
    /// </summary>
    string? InputStreamCastTemplate { get; }

    // ???????????????????????????????????????????????????????????????????
    // MODULE INIT TEMPLATES
    // ???????????????????????????????????????????????????????????????????

    /// <summary>
    /// Шаблон module init (регистрация форматтеров и executor'ов).
    /// </summary>
    string ModuleInitTemplate { get; }

    // ???????????????????????????????????????????????????????????????????
    // PROXY TEMPLATES (Client-side factory)
    // ???????????????????????????????????????????????????????????????????

    /// <summary>
    /// Шаблон client proxy/factory (для TypeScript).
    /// </summary>
    string? ClientProxyTemplate { get; }
}

/// <summary>
/// Контекст для подстановки в шаблоны.
/// </summary>
public class TemplateContext : Dictionary<string, string>
{
    public TemplateContext Set(string key, string value)
    {
        this[key] = value;
        return this;
    }

    public TemplateContext SetIf(bool condition, string key, string value)
    {
        if (condition) this[key] = value;
        return this;
    }

    public string Apply(string template)
    {
        var result = template;
        foreach (var (key, value) in this)
        {
            result = result.Replace($"{{{key}}}", value);
        }
        return result;
    }
}
